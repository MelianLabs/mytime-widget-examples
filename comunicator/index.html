<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTime Communicator</title>
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <!-- Axios for API calls -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    <div id="root"></div>
    <script type="text/babel">
        function App() {
            const [formData, setFormData] = React.useState({
                baseUrl: '',
                companyId: '',
                email: '',
                password: ''
            });
            const [error, setError] = React.useState('');
            const [successMessage, setSuccessMessage] = React.useState('');
            const [authToken, setAuthToken] = React.useState('');
            const [userData, setUserData] = React.useState(null);
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);
            const [isLoading, setIsLoading] = React.useState(false);
            const [unreadMessages, setUnreadMessages] = React.useState([]);
            const [locations, setLocations] = React.useState([]);
            const [isLoadingMessages, setIsLoadingMessages] = React.useState(false);
            const [messagesError, setMessagesError] = React.useState('');
            const [selectedLocation, setSelectedLocation] = React.useState(null);
            const [locationMessages, setLocationMessages] = React.useState({});
            const [isLoadingLocationMessages, setIsLoadingLocationMessages] = React.useState({});
            const [hasMoreMessages, setHasMoreMessages] = React.useState({});
            const [loadingMoreMessages, setLoadingMoreMessages] = React.useState({});

            // Load URL parameters on component mount
            React.useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const baseUrl = params.get('base_url');
                const companyId = params.get('company_id');
                const email = params.get('email');
                const password = params.get('password');
                
                const newFormData = {};
                if (baseUrl) newFormData.baseUrl = baseUrl;
                if (companyId) newFormData.companyId = companyId;
                if (email) newFormData.email = email;
                if (password) newFormData.password = password;
                
                if (Object.keys(newFormData).length > 0) {
                    setFormData(prev => ({
                        ...prev,
                        ...newFormData
                    }));
                }
            }, []);

            const fetchLocationMessages = async (locationId, createdBefore = null) => {
                if (!locationId || !formData.baseUrl || !authToken) return;

                if (!createdBefore) {
                    setIsLoadingLocationMessages(prev => ({
                        ...prev,
                        [locationId]: true
                    }));
                } else {
                    setLoadingMoreMessages(prev => ({
                        ...prev,
                        [locationId]: true
                    }));
                }

                try {
                    const baseUrlWithoutTrailingSlash = formData.baseUrl.replace(/\/$/, '');
                    const params = {
                        auth_token: authToken,
                        location_ids: locationId
                    };
                    
                    if (createdBefore) {
                        params.created_before = createdBefore;
                    }
                    
                    const response = await axios.get(
                        `${baseUrlWithoutTrailingSlash}/my_client/users/messages`,
                        {
                            params,
                            headers: {
                                'Accept': 'application/json'
                            }
                        }
                    );

                    const messages = response.data.messages || [];
                    
                    // Update hasMoreMessages state based on whether we received any messages
                    setHasMoreMessages(prev => ({
                        ...prev,
                        [locationId]: messages.length === 6 // If we got exactly 6 messages, there might be more
                    }));

                    if (createdBefore) {
                        // Append new messages to existing ones
                        setLocationMessages(prev => ({
                            ...prev,
                            [locationId]: [...(prev[locationId] || []), ...messages]
                        }));
                    } else {
                        // Replace existing messages
                        setLocationMessages(prev => ({
                            ...prev,
                            [locationId]: messages
                        }));
                    }

                    return messages;
                } catch (err) {
                    console.error('Error fetching location messages:', err);
                    setMessagesError('Failed to load messages for this location. Please try again.');
                    return [];
                } finally {
                    if (!createdBefore) {
                        setIsLoadingLocationMessages(prev => ({
                            ...prev,
                            [locationId]: false
                        }));
                    } else {
                        setLoadingMoreMessages(prev => ({
                            ...prev,
                            [locationId]: false
                        }));
                    }
                }
            };
            
            const loadMoreMessages = async (locationId) => {
                if (!locationId || !locationMessages[locationId] || loadingMoreMessages[locationId]) return;
                
                const messages = locationMessages[locationId];
                if (messages.length === 0) return;
                
                // Get the oldest message's created_at date
                const oldestMessage = messages[messages.length - 1];
                if (oldestMessage && oldestMessage.created_at) {
                    // Convert created_at to timestamp (seconds since epoch)
                    const timestamp = Math.floor(new Date(oldestMessage.created_at).getTime());
                    await fetchLocationMessages(locationId, timestamp);
                }
            };

            const handleLocationClick = async (locationId) => {
                setSelectedLocation(selectedLocation === locationId ? null : locationId);
                
                // If we haven't loaded messages for this location yet, fetch them
                if ((!locationMessages[locationId] || locationMessages[locationId].length === 0) && 
                    !isLoadingLocationMessages[locationId]) {
                    await fetchLocationMessages(locationId);
                }
            };

            const fetchLocations = async (baseUrl, companyId, token) => {
                try {
                    const baseUrlWithoutTrailingSlash = baseUrl.replace(/\/$/, '');
                    const response = await axios.get(
                        `${baseUrlWithoutTrailingSlash}/api/mkp/v1/companies/${companyId}/locations`,
                        {
                            headers: {
                                'Accept': 'application/json',
                                'Authorization': token
                            }
                        }
                    );
                    return response.data.locations || [];
                } catch (err) {
                    console.error('Error fetching locations:', err);
                    return [];
                }
            };

            const fetchUnreadMessages = async (baseUrl, companyId, token) => {
                try {
                    const baseUrlWithoutTrailingSlash = baseUrl.replace(/\/$/, '');
                    const response = await axios.get(
                        `${baseUrlWithoutTrailingSlash}/my_client/users/messages/unread.json`,
                        {
                            params: {
                                auth_token: token,
                                company_id: companyId,
                                with_location_ids: true
                            },
                            headers: {
                                'Accept': 'application/json'
                            }
                        }
                    );
                    return response.data.unread || [];
                } catch (err) {
                    console.error('Error fetching unread messages:', err);
                    throw err;
                }
            };

            // Fetch all locations for the company
            const fetchAllLocations = async (baseUrl, companyId, token) => {
                try {
                    const baseUrlWithoutTrailingSlash = baseUrl.replace(/\/$/, '');
                    const response = await axios.get(
                        `${baseUrlWithoutTrailingSlash}/api/mkp/v1/companies/${companyId}/locations`,
                        {
                            params: {
                                auth_token: token
                            },
                            headers: {
                                'Accept': 'application/json'
                            }
                        }
                    );
                    return response.data.locations || [];
                } catch (err) {
                    console.error('Error fetching locations:', err);
                    throw err;
                }
            };

            const handleLogin = async (baseUrl, email, password, companyId) => {
                setIsLoading(true);
                setError('');
                setSuccessMessage('');
                setMessagesError('');
                
                try {
                    const baseUrlWithoutTrailingSlash = baseUrl.replace(/\/$/, '');
                    
                    const loginResponse = await axios.post(
                        `${baseUrlWithoutTrailingSlash}/api/mkp/v1/sessions`,
                        {
                            email: email,
                            password: password,
                            company_id: parseInt(companyId),
                            recaptcha_token: null
                        },
                        {
                            headers: {
                                'Accept': 'application/json'
                            }
                        }
                    );
                    
                    if (loginResponse.data && loginResponse.data.user && loginResponse.data.user.authentication_token) {
                        const token = loginResponse.data.user.authentication_token;
                        setAuthToken(token);
                        setUserData(loginResponse.data.user);
                        setIsLoggedIn(true);
                        setSuccessMessage('Login successful!');
                        
                        // After successful login, fetch all locations and unread messages
                        setIsLoadingMessages(true);
                        setMessagesError('');

                        try {
                            const [allLocations, unreadMsgs] = await Promise.all([
                                fetchAllLocations(formData.baseUrl, formData.companyId, token),
                                fetchUnreadMessages(formData.baseUrl, formData.companyId, token)
                            ]);

                            // Create a map of location_id to unread count
                            const unreadMap = {};
                            unreadMsgs.forEach(msg => {
                                unreadMap[msg.location_id] = msg.unread;
                            });

                            // Merge locations with unread counts
                            const locationsWithUnread = allLocations.map(location => ({
                                ...location,
                                unread: unreadMap[location.id] || 0
                            }));

                            setLocations(locationsWithUnread);
                            setUnreadMessages(unreadMsgs);
                            setIsLoadingMessages(false);
                        } catch (err) {
                            setMessagesError('Failed to load messages. Please try refreshing the page.');
                            console.error('Error loading messages:', err);
                        } finally {
                            setIsLoadingMessages(false);
                        }
                        
                        return token;
                    } else {
                        throw new Error('Invalid login response');
                    }
                } catch (err) {
                    let errorMessage = 'Login failed';
                    if (err.response && err.response.data) {
                        errorMessage = JSON.stringify(err.response.data, null, 2);
                    } else if (err.message) {
                        errorMessage = err.message;
                    }
                    setError(errorMessage);
                    console.error('Login Error:', err);
                    return null;
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // Validate form data
                if (!formData.baseUrl || !formData.companyId || !formData.email || !formData.password) {
                    setError('All fields are required.');
                    return;
                }
                
                await handleLogin(formData.baseUrl, formData.email, formData.password, formData.companyId);
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            return (
                <div className="max-w-2xl mx-auto">
                    <h1 className="text-2xl font-bold mb-6 text-center">MyTime Communicator</h1>
                    
                    {!isLoggedIn ? (
                        <form onSubmit={handleSubmit} className="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="baseUrl">
                                    Base URL
                                </label>
                                <input
                                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                    id="baseUrl"
                                    type="text"
                                    name="baseUrl"
                                    value={formData.baseUrl}
                                    onChange={handleInputChange}
                                    placeholder="www.mytime.com"
                                />
                                <p className="text-xs text-gray-500 mt-1">Can be set via URL parameter: ?base_url=www.mytime.com</p>
                            </div>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="companyId">
                                    Company ID
                                </label>
                                <input
                                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                    id="companyId"
                                    type="text"
                                    name="companyId"
                                    value={formData.companyId}
                                    onChange={handleInputChange}
                                    placeholder="40426"
                                />
                                <p className="text-xs text-gray-500 mt-1">Can be set via URL parameter: ?company_id=40426</p>
                            </div>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">
                                    Email
                                </label>
                                <input
                                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                                    id="email"
                                    type="email"
                                    name="email"
                                    value={formData.email}
                                    onChange={handleInputChange}
                                    placeholder="user@example.com"
                                />
                                <p className="text-xs text-gray-500 mt-1">Can be set via URL parameter: ?email=user@example.com</p>
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">
                                    Password
                                </label>
                                <input
                                    className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
                                    id="password"
                                    type="password"
                                    name="password"
                                    value={formData.password}
                                    onChange={handleInputChange}
                                    placeholder="******************"
                                />
                                <p className="text-xs text-gray-500">Note: It's not recommended to pass passwords via URL for security reasons.</p>
                            </div>
                            <div className="flex items-center justify-between">
                                <button
                                    className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                                    type="submit"
                                    disabled={isLoading}
                                >
                                    {isLoading ? 'Logging in...' : 'Sign In'}
                                </button>
                            </div>
                        </form>
                    ) : (
                        <div className="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold">Welcome, {userData.first_name}!</h2>
                                <button
                                    onClick={() => {
                                        setIsLoggedIn(false);
                                        setAuthToken('');
                                        setUserData(null);
                                        setSuccessMessage('You have been logged out.');
                                    }}
                                    className="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm"
                                >
                                    Logout
                                </button>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-gray-50 p-4 rounded">
                                    <h3 className="font-bold mb-2">User Information</h3>
                                    <p><span className="font-semibold">Name:</span> {userData.first_name} {userData.last_name}</p>
                                    <p><span className="font-semibold">Email:</span> {userData.email}</p>
                                    <p><span className="font-semibold">User ID:</span> {userData.id}</p>
                                    {userData.phone && <p><span className="font-semibold">Phone:</span> {userData.phone}</p>}
                                </div>
                                <div className="bg-gray-50 p-4 rounded">
                                    <h3 className="font-bold mb-2">Authentication</h3>
                                    <p><span className="font-semibold">Token:</span> {authToken.substring(0, 15)}...</p>
                                    <p><span className="font-semibold">Company ID:</span> {formData.companyId}</p>
                                </div>
                            </div>
                            
                            <div className="mt-6">
                                <h3 className="text-lg font-bold mb-4">Unread Messages</h3>
                                {isLoadingMessages ? (
                                    <p>Loading messages...</p>
                                ) : messagesError ? (
                                    <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
                                        {messagesError}
                                    </div>
                                ) : unreadMessages.length === 0 ? (
                                    <p>No unread messages</p>
                                ) : (
                                    <div className="space-y-4">
                                            {locations.map((location, index) => {
                                                const locationName = location.street_address 
                                                    ? `${location.street_address}${location.city ? `, ${location.city}` : ''}${location.state ? ` ${location.state}` : ''}`.trim()
                                                    : `Location ID: ${location.id}`;
                                                const unreadCount = location.unread || 0;
                                                
                                            return (
                                                <div key={index} className="border rounded overflow-hidden">
                                                    <div 
                                                        className="flex justify-between items-start p-4 hover:bg-gray-50 cursor-pointer"
                                                        onClick={() => handleLocationClick(location.id)}
                                                    >
                                                        <div className="flex-1">
                                                            <h4 className="font-semibold">{locationName}</h4>
                                                            <p className="text-gray-600">
                                                                {unreadCount > 0 
                                                                    ? `${unreadCount} unread message${unreadCount !== 1 ? 's' : ''}`
                                                                    : 'No unread messages'}
                                                            </p>
                                                        </div>
                                                        <div className="flex items-center">
                                                            {unreadCount > 0 && (
                                                                <span className="bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full mr-2">
                                                                    {unreadCount}
                                                                </span>
                                                            )}
                                                            <svg 
                                                                className={`w-4 h-4 text-gray-500 transform transition-transform ${selectedLocation === location.id ? 'rotate-180' : ''}`} 
                                                                fill="none" 
                                                                stroke="currentColor" 
                                                                viewBox="0 0 24 24" 
                                                                xmlns="http://www.w3.org/2000/svg"
                                                            >
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                            </svg>
                                                        </div>
                                                    </div>
                                                    
                                                    {selectedLocation === location.id && (
                                                        <div className="border-t p-4 bg-gray-50">
                                                            {isLoadingLocationMessages[location.id] ? (
                                                                <div className="text-center py-4">
                                                                    <svg className="animate-spin h-5 w-5 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                                    </svg>
                                                                </div>
                                                            ) : (
                                                                <div className="space-y-3 max-h-96 overflow-y-auto" 
                                                                    id={`message-container-${location.id}`}
                                                                    onScroll={(e) => {
                                                                        const container = e.target;
                                                                        // If scrolled to bottom and we have more messages
                                                                        if (container.scrollHeight - container.scrollTop <= container.clientHeight + 50 && 
                                                                            hasMoreMessages[location.id] && 
                                                                            !loadingMoreMessages[location.id]) {
                                                                            loadMoreMessages(location.id);
                                                                        }
                                                                    }}
                                                                >
                                                                    {locationMessages[location.id] && locationMessages[location.id].length > 0 ? (
                                                                        <div>
                                                                            {locationMessages[location.id].map((msg, msgIndex) => (
                                                                                <div key={msgIndex} className="border-b pb-3 last:border-b-0 last:pb-0 last:mb-0">
                                                                                    <div className="flex justify-between items-start">
                                                                                        <div className="flex-1">
                                                                                            <div className="flex items-center justify-between">
                                                                <span className="font-medium">
                                                                    {msg.emp_fullname || 'Staff'}
                                                                </span>
                                                                <span className="text-xs text-gray-500 whitespace-nowrap ml-2">
                                                                    {new Date(msg.created_at).toLocaleString()}
                                                                </span>
                                                            </div>
                                                            <p className="mt-1 text-sm text-gray-700 whitespace-pre-line">{msg.content || 'No content'}</p>
                                                            {!msg.read_at && !msg.outgoing && (
                                                                <span className="inline-block mt-1 text-xs text-blue-600">
                                                                    New
                                                                </span>
                                                            )}
                                                            {msg.outgoing && (
                                                                <span className="inline-block mt-1 text-xs text-gray-500">
                                                                    {msg.read_at ? 'Read' : 'Sent'}
                                                                </span>
                                                            )}
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            ))}
                                                                            
                                                                            {loadingMoreMessages[location.id] && (
                                                                                <div className="text-center py-2">
                                                                                    <svg className="animate-spin h-4 w-4 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                                                    </svg>
                                                                                </div>
                                                                            )}
                                                                            
                                                                            {!hasMoreMessages[location.id] && locationMessages[location.id].length > 6 && (
                                                                                <div className="text-center py-2 text-xs text-gray-500">
                                                                                    No more messages
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    ) : (
                                                                        <p className="text-gray-500 text-center py-2">No messages found for this location</p>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {error && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4">
                            <strong className="font-bold">Error: </strong>
                            <span className="block sm:inline">{error}</span>
                        </div>
                    )}
                    
                    {successMessage && (
                        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4">
                            {successMessage}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>